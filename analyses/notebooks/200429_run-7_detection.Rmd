---
title: "Run07 - Limit of Detection"
author: "Nate"
date: "04/29/2020"
output: 
  github_document:
    toc: true
    toc_depth: 2
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.width=12, 
  fig.height=8, 
  fig.path='figs/run7-detection',
  echo=TRUE, 
  warning=FALSE, 
  message=FALSE
)
```

# Setup

Import and load everything

```{r imports}
# plotting
library(ggbeeswarm) # <- geom_quasirandom

# tidyverse
library(magrittr)
library(tidyverse)

# ------------------------------------------------------------------------------------
# style plots

theme_pub <- function(base_size = 11, base_family = "") {
  # based on https://github.com/noamross/noamtools/blob/master/R/theme_nr.R
  # start with theme_bw and modify from there!
  theme_bw(base_size = base_size, base_family = base_family) +# %+replace%
    theme(
      # grid lines
      panel.grid.major.x = element_line(colour="#ECECEC", size=0.5, linetype=1),
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_line(colour="#ECECEC", size=0.5, linetype=1),
      panel.background   = element_blank(),
      
      # axis options
      axis.ticks.y   = element_blank(),
      axis.title.x   = element_text(size=rel(2), vjust=0.25),
      axis.title.y   = element_text(size=rel(2), vjust=0.35),
      axis.text      = element_text(color="black", size=rel(1)),
      
      # legend options
      legend.title    = element_text(size=rel(1.5)),
      legend.key      = element_rect(fill="white"),
      legend.key.size = unit(1, "cm"),
      legend.text     = element_text(size=rel(1.5)),
      
      # facet options
      strip.text = element_text(size=rel(2)),
      strip.background = element_blank(),
      
      # title options
      plot.title = element_text(size=rel(2.25), vjust=0.25, hjust=0.5)
    )
}
theme_set(theme_pub(base_size=8))

# ------------------------------------------------------------------------------------
# load data

nextseq <- '200429_NB552046_0040_AHVGFNBGXF'
miseq <- '200429_M05737_0146_000000000-J46DN'

# raw kallisto counts
kallisto.counts <- bind_rows(
  nextseq = read_tsv(str_c('../../pipeline/', nextseq, '/kallisto.counts.tsv'), col_names = c('i7i5', 'foo', 'ref', 'counts')),
  miseq = read_tsv(str_c('../../pipeline/', miseq, '/kallisto.counts.tsv'), col_names = c('i7i5', 'foo', 'ref', 'counts')),
  .id = 'sequencer'
) %>%
  mutate(
    index =  str_sub(i7i5, end=10),
    index2 = str_sub(i7i5, start=11)
  )

# reads aligning to our library
counts <- bind_rows(
  nextseq = read_tsv(str_c('../../pipeline/', nextseq, '/kb.tsv'), col_names = c('i7i5', 'foo', 'ref', 'counts')),
  miseq = read_tsv(str_c('../../pipeline/', miseq, '/kb.tsv'), col_names = c('i7i5', 'foo', 'ref', 'counts')),
  .id = 'sequencer'
) %>%
  mutate(
    index =  str_sub(i7i5, end=10),
    index2 = str_sub(i7i5, start=11)
  ) %>%
  select(-foo)

bc.map <- bind_rows(
  nextseq = read_tsv(str_c('../../pipeline/', nextseq, '/transcripts.txt'), col_names = 'amplicon'),
  miseq =   read_tsv(str_c('../../pipeline/', miseq,   '/transcripts.txt'), col_names = 'amplicon'),
  .id = 'sequencer'
) %>%
  group_by(sequencer) %>%
  mutate(ref = 1:n() - 1) %>%
  ungroup() %>%
  filter(str_detect(amplicon, 'N1', negate=TRUE)) %>%
  mutate(target = if_else(str_detect(amplicon, 'S2'), 'S2', 'RPP30'))

cond <- bind_rows(
  nextseq = read_csv(str_c('../../pipeline/', nextseq, '/conditions.csv')),
  miseq =   read_csv(str_c('../../pipeline/', miseq,   '/conditions.csv')),
  .id = 'sequencer'
) %>%
  mutate(target = if_else(str_sub(Sample_ID, -1, -1) == '1', 'S2', 'RPP30'))
```

## Reads per Well

```{r, count-per-well, fig.width=9, fig.height=3.33}
counts %>%
  inner_join(bc.map) %>%
  inner_join(cond) %>%
  count(sequencer, Plate_ID, Sample_Well, wt=counts, name='well_total') %>%
  mutate(
    Row = factor(str_sub(Sample_Well, 1, 1), levels = rev(LETTERS[1:16])),
    Col = str_sub(Sample_Well, 2)
  ) %>%
  ggplot(aes(x=Col, y=Row, fill=log10(well_total))) +
  geom_tile() +
  coord_equal() +
  facet_grid(Plate_ID ~ sequencer) +
  scale_fill_viridis_c(option='plasma')
```

### Split out By Amplicon

```{r, rpw-amplicon, fig.width=9, fig.height=4.5}
counts %>%
  inner_join(bc.map) %>%
  inner_join(cond) %>%
  mutate(
    Row = factor(str_sub(Sample_Well, 1, 1), levels = rev(LETTERS[1:16])),
    Col = str_sub(Sample_Well, 2)
  ) %>%
  ggplot(aes(x=Col, y=Row, fill=log10(counts + 1))) +
  geom_tile() +
  coord_equal() +
  facet_grid(sequencer ~ amplicon) +
  scale_fill_viridis_c(option='plasma')
```

## Explicit Zeros

Since we know what barcodes to expect in each well, we can add explicit zeros to barcodes that drop out.

```{r, explicit-zero-check, fig.width=9, fig.height=4.5}
df <- left_join(cond, bc.map)  %>%
  left_join(counts) %>%
  select(-i7i5) %>%
  replace_na(list(counts = 0)) %>%
  mutate(
    Row = factor(str_sub(Sample_Well, 1, 1), levels = rev(LETTERS)),
    Col = str_sub(Sample_Well, 2)
  ) 

df %>%
 ggplot(aes(x=Col, y=Row, fill=log10(counts + 1))) +
  geom_tile() +
  coord_equal() +
  facet_grid(sequencer ~ amplicon) +
  scale_fill_viridis_c(option='plasma')
```

## Getting Oriented

This experiment is very simple - one plate, RNA titration, and NextSeq vs Miseq

```{r, plate-setup, fig.width=9, fig.height=3.33}
df %>%
  ggplot(aes(x=Col, y=Row, fill=log10(RNA_copies))) +
  geom_raster() +
  facet_wrap(~sequencer) +
  scale_fill_viridis_c()
```

### Grab Nulls and Well Totals

We need to get our amplicon, spike, and Rpp30 reads into separate columns. From that, we can grab our nulls.

```{r, nulls-and-wells}
well.total <- df %>%
  count(sequencer, Row, Col, wt=counts, name='Well_Total')

# because our data is pretty simple we can just modify the nulls in place
df.wide <- df %>%
  filter(amplicon == 'RPP30' | str_detect(amplicon, 'S2')) %>%
  mutate(amplicon = case_when(amplicon == 'RPP30' ~ 'RPP30',
                              str_detect(amplicon, 'spike') ~ 'Spike',
                              TRUE ~ 'RNA')
  ) %>%
  select(sequencer, Row, Col, RNA_copies, amplicon, counts) %>%
  spread(amplicon, counts)

nulls <- df.wide %>%
  filter(RNA_copies == 0) %>%
  mutate(RNA_copies = 0.1) %>%
  nest(nulls = c(-sequencer))
```

# Basic Plot

```{r, detection_plot, fig.width=9, fig.height=4.5}
df.wide %>%
    inner_join(well.total) %>%
    mutate(RNA_copies = if_else(RNA_copies == 0, 0.1, RNA_copies)) %>%
    ggplot(aes(x=RNA_copies, y=(RNA+1)/(Spike+1), group=RNA_copies)) +
    geom_boxplot(outlier.shape = NA) +
    geom_quasirandom(alpha=0.4, aes(color=log10(Well_Total))) +
    scale_x_log10(breaks = c(10^(-1:4)), labels = c(0,10^(0:4))) +
    scale_y_log10() +
    facet_wrap(~sequencer, ncol=1) +
    scale_color_viridis_c(option = 'plasma')
```

# No Template Control Issues

Let's plot the raw counts in the no template control wells (looking at nextseq only)

```{r, ntc-reads, fig.width=4, fig.height=3}
df %>%
    filter(RNA_copies == 0, sequencer == 'nextseq') %>%
    ggplot(aes(x=amplicon, y=counts + 1)) +
    geom_boxplot(outlier.shape = NA) +
    geom_quasirandom(alpha=0.3, width=0.3) +
    scale_y_log10() +
    annotation_logticks(sides = 'l')
```

Our expectation is that no S2 amplicon should have any reads. We can see that we are not too far off - the median read counts ~10. However, there is a long tail of wells with >1000 reads!

## S2_Spike Correlation

### No Template Wells

Maybe 

```{r, s2-vs-spike_corr, fig.width=5, fig.height=4}
df.wide %>%
  filter(RNA_copies == 0, sequencer == 'nextseq') %>%
  ggplot(aes(y=RNA + 1, x=Spike + 1, color=log10(RPP30))) +
  geom_point() +
  geom_abline() +
  geom_smooth(se=F) +
  scale_x_log10() +
  scale_y_log10() +
  annotation_logticks() +
  scale_color_viridis_c()
```

### Max Template Wells

```{r, s2-vs-spike_corr_max, fig.width=5, fig.height=4}
df.wide %>%
  filter(RNA_copies == 30000, sequencer == 'nextseq') %>%
  ggplot(aes(y=RNA + 1, x=Spike + 1, color=log10(RPP30))) +
  geom_point() +
  geom_abline() +
  geom_smooth(se=F) +
  scale_x_log10() +
  scale_y_log10() +
  annotation_logticks() +
  scale_color_viridis_c()
```

### Finding Good/Bad Wells

Let's find the top5 most represented wells in the no temoplate control condition

```{r, ntc-outliers, message=T}
df.wide %>%
  filter(RNA_copies == 0) %>%
  group_by(sequencer) %>%
  top_n(5, wt=RNA) %>%
  arrange(sequencer, RNA)
```

Encouragingly they are the same across sequencers.

